<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’è¡Œæ¦œ JSON ç‡Ÿé‹è¨­å®šå·¥å…· (æ——è‰¦å®Œæ•´ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #2563eb; --secondary-color: #6366f1; --bg-color: #f1f5f9; --card-bg: #ffffff; --border-color: #cbd5e1; --text-color: #0f172a; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 340px; background: #1e293b; color: white; display: flex; flex-direction: column; border-right: 1px solid #0f172a; }
        .sidebar-header { padding: 20px; background: #0f172a; }
        .round-list { flex: 1; overflow-y: auto; padding: 10px; }
        .round-item { padding: 12px 15px; margin-bottom: 8px; background: #334155; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .round-item.active { background: var(--primary-color); box-shadow: 0 0 10px rgba(37,99,235,0.3); }
        .main-content { flex: 1; overflow-y: auto; padding: 25px 40px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; gap: 4px; }
        label { font-weight: 600; font-size: 0.8rem; color: #64748b; }
        input, select, textarea { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-ghost { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .json-preview { background: #0f172a; color: #38bdf8; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; white-space: pre; overflow: auto; max-height: 400px; }
        .item-badge { background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-top: 4px; display: block; font-weight: bold; }
        .prize-item { background: #f8fafc; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .reward-row { display: grid; grid-template-columns: 1.5fr 1fr auto; gap: 8px; margin-top: 5px; align-items: start; }
        .params-container { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--border-color); margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 12px; width: 65%; max-height: 85%; overflow-y: auto; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0 0 10px 0">BQRankTool æ§åˆ¶å°</h3>
        <button class="btn btn-primary" style="width:100%" onclick="addNewRound()">+ æ–°å¢æ´»å‹•è¼ªæ¬¡</button>
        <button class="btn btn-secondary" style="width:100%; margin-top:12px" onclick="showImportModal()">ğŸ“¥ åŒ¯å…¥æ­£å¼ JSON</button>
        <button class="btn btn-secondary" style="width:100%; margin-top:10px" onclick="document.getElementById('item_file_input').click()">ğŸ“Š åŒ¯å…¥é“å…·å°ç…§è¡¨ (.xlsx)</button>
        <div id="item_status" style="font-size:0.7rem; margin-top:5px; color:#94a3b8">âŒ å°šæœªåŒ¯å…¥é“å…·è¡¨</div>
        <input type="file" id="item_file_input" style="display:none" accept=".xlsx,.csv" onchange="handleItemFile(event)">
    </div>
    <div class="round-list" id="round_list_ui"></div>
    <div style="padding:20px; border-top: 1px solid #0f172a;">
        <div class="form-group"><label style="color:#94a3b8">JSON ç¾¤çµ„åç¨±</label><input type="text" id="group_name" value="260213_æ’è¡Œæ¦œ_è¨­å®š" oninput="updatePreview()"></div>
        <button class="btn btn-success" style="width:100%" onclick="downloadJson()">ğŸ’¾ åŒ¯å‡ºå…¨éƒ¨ JSON</button>
    </div>
</div>

<div class="main-content">
    <header><h2 id="editing_title">æ­£åœ¨ç·¨è¼¯ï¼šæœªå‘½åæ´»å‹•</h2><button class="btn btn-ghost" onclick="cloneCurrentRound()">ğŸ‘¯ è¤‡è£½ç›®å‰æ´»å‹•</button></header>
    
    <div class="grid">
        <!-- 1. æ ¸å¿ƒé‚è¼¯ -->
        <div class="card" style="grid-column: span 2">
            <div class="section-title">1. æ’è¡Œæ¦œåˆ¤æ–·é‚è¼¯ (Procedure & Params)</div>
            <div class="grid">
                <div class="form-group">
                    <label>Procedure ID</label>
                    <select id="bq_procedure_id" onchange="handleProcedureChange(this.value)">
                        <option value="">-- è«‹é¸æ“‡åˆ¤æ–·æ¢ä»¶ --</option>
                        <option value="Custom_Bison.f_cal_FishTotalWinTimes_FishID">é­šç¨®ç¸½æ“Šæ®ºæ¬¡æ•¸</option>
                        <option value="Custom_Bison.f_cal_SlotMaxMultiple_GameID">è™æ©Ÿæœ€å¤§å€æ•¸</option>
                        <option value="Custom_Bison.f_cal_FishMaxMultiple_FishID">é­šç¨®æœ€å¤§å€æ•¸</option>
                        <option value="Custom_Bison.f_cal_CardCollect">å¡ç‰‡æ”¶é›†é€²åº¦</option>
                        <option value="Custom_Bison.f_cal_CosmicSagaCompleteTimes">å¢æ—ä¹‹ç‹é—œå¡æ•¸</option>
                        <option value="Custom_Bison.f_cal_FishMaxWin_FishID">é­šæ©Ÿæœ€é«˜è´åˆ†</option>
                        <option value="Custom_Bison.f_cal_SlotMaxWin_GameID">è™æ©Ÿæœ€é«˜è´åˆ†</option>
                        <option value="Custom_Bison.f_cal_LiveEventsCompleteTimes">é™æ™‚æ´»å‹•é—œå¡æ•¸</option>
                        <option value="Custom_Bison.f_cal_SpaceTravelPoints">å¤ªç©ºæ—…è¡Œé»æ•¸</option>
                        <option value="Custom_Bison.f_cal_CardNumber">å¡ç‰‡æ”¶é›†å¼µæ•¸</option>
                        <option value="Custom_Bison.f_cal_SlotMaxWin_MinMult_GameID">è™æ©Ÿæœ€é«˜è´åˆ†(æœ‰ä¸Šæ¦œé™åˆ¶)</option>
                        <option value="Custom_Bison.f_cal_SlotMaxMultiple_MinMult_GameID">è™æ©Ÿæœ€é«˜è´åˆ†å€æ•¸(æœ‰ä¸Šæ¦œé™åˆ¶)</option>
                        <option value="CUSTOM">-- æ‰‹å‹•è¼¸å…¥ ID --</option>
                    </select>
                    <input type="text" id="custom_procedure_input" style="display:none; margin-top:5px" placeholder="è«‹è¼¸å…¥ Procedure ID" oninput="handleInput(event, 'bq_procedure_id')">
                </div>
                <div class="form-group"><label>Round ID (å”¯ä¸€è­˜åˆ¥ç¢¼)</label><input type="text" id="round_id" oninput="handleInput(event, 'round_id')"></div>
            </div>
            <div id="params_ui_container" class="params-container"></div>
            <div class="form-group" style="margin-top:10px">
                <label>Raw BQ Params (æ‰‹å‹•ä¿®æ­£)</label>
                <input type="text" id="bq_extra_params_raw" oninput="handleRawParamsInput(this.value)">
            </div>
        </div>

        <!-- 2. åˆ†é¡èˆ‡é—œè¯ -->
        <div class="card">
            <div class="section-title">2. åˆ†é¡èˆ‡é—œè¯è¨­å®š</div>
            <div class="grid">
                <div class="form-group"><label>Category</label><select id="category" onchange="handleInput(event, 'category')"><option value="EVENT">EVENT</option><option value="SLOT">SLOT</option><option value="SHOOTING">SHOOTING</option><option value="GRANDMASTER">GRANDMASTER</option></select></div>
                <div class="form-group"><label>Sub Category</label><input type="text" id="sub_category" oninput="handleInput(event, 'sub_category')"></div>
                <div class="form-group"><label>Series ID (ç³»åˆ—)</label><input type="text" id="round_series_id" oninput="handleInput(event, 'round_series_id')"></div>
                <div class="form-group"><label>Previous ID (å‰ä¸€æª”)</label><input type="text" id="previous_round_id" oninput="handleInput(event, 'previous_round_id')"></div>
                <div class="form-group" style="grid-column: span 2"><label>Sub Category Params</label><input type="text" id="sub_category_params" oninput="handleInput(event, 'sub_category_params')"></div>
            </div>
        </div>

        <!-- 3. æ™‚é–“èˆ‡é¡¯ç¤ºæ§åˆ¶ -->
        <div class="card">
            <div class="section-title">3. æ™‚é–“èˆ‡é¡¯ç¤ºæ§åˆ¶</div>
            <div class="grid">
                <div class="form-group"><label>é–‹å§‹æ™‚é–“</label><input type="datetime-local" id="start_dt_picker" step="60" onchange="handleDateInput(event, 'start_dt')"></div>
                <div class="form-group"><label>çµæŸæ™‚é–“</label><input type="datetime-local" id="end_dt_picker" step="60" onchange="handleDateInput(event, 'end_dt')"></div>
                <div class="form-group"><label>ç½®çæ™‚é–“</label><input type="datetime-local" id="reward_dt_picker" step="60" onchange="handleDateInput(event, 'reward_dt')"></div>
                <div class="form-group"><label>å„ªå…ˆåº (Priority)</label><input type="number" id="priority" oninput="handleNumInput(event, 'priority')"></div>
                <div class="form-group"><label>é¡¯ç¤ºå»£å®£ (Winner Announce)</label><select id="show_winner_announce" onchange="handleNumInput(event, 'show_winner_announce')"><option value="0">å¦ (0)</option><option value="1">æ˜¯ (1)</option></select></div>
                <div class="form-group"><label>æ¦œå–®äººæ•¸ (Size)</label><input type="number" id="ranking_size" oninput="handleNumInput(event, 'ranking_size')"></div>
            </div>
        </div>

        <!-- 4. æ•¸å€¼èˆ‡è¨Šæ¯ -->
        <div class="card" style="grid-column: span 2">
            <div class="section-title">4. æ•¸å€¼æ ¼å¼èˆ‡ä»‹é¢è¨Šæ¯</div>
            <div class="grid">
                <div class="form-group"><label>åˆ†æ•¸é¡å‹</label><select id="score_type" onchange="handleInput(event, 'score_type')"><option value="int">int</option><option value="multiplier">multiplier</option><option value="coin">coin</option></select></div>
                <div class="form-group"><label>åˆ†æ•¸ Icon ID</label><input type="text" id="score_icon" oninput="handleInput(event, 'score_icon')"></div>
                <div class="form-group"><label>ç§€æ©Ÿå° Icon</label><select id="show_score_source" onchange="handleNumInput(event, 'show_score_source')"><option value="0">å¦ (0)</option><option value="1">æ˜¯ (1)</option></select></div>
                <div class="form-group"><label>å½ˆçª—ç½®çåæ¬¡</label><input type="number" id="popup_reward_rank" oninput="handleNumInput(event, 'popup_reward_rank')"></div>
                <div class="form-group"><label>ç‰ˆå‹ (Template)</label><input type="text" id="template_code" oninput="handleInput(event, 'template_code')"></div>
                <div class="form-group"><label>è¨Šæ¯ï¼šæ¨™é¡Œ</label><input type="text" id="msg_title" oninput="handleInput(event, 'msg_title')"></div>
            </div>
            <div class="grid" style="margin-top:10px">
                <div class="form-group"><label>è¨Šæ¯ï¼šèªªæ˜ (Desc)</label><textarea id="msg_desc" rows="2" oninput="handleInput(event, 'msg_desc')"></textarea></div>
                <div class="form-group"><label>è¨Šæ¯ï¼šæ¢ä»¶ (Cond)</label><textarea id="msg_cond" rows="2" oninput="handleInput(event, 'msg_cond')"></textarea></div>
            </div>
        </div>

        <!-- 5. çå‹µè¨­å®š (å…·é¸å–®åŠŸèƒ½) -->
        <div class="card" style="grid-column: span 2">
            <div class="section-title"><span>ğŸ 5. çå‹µè¨­å®š (Prizes)</span>
                <div><button class="btn btn-sm btn-primary" onclick="switchPrizeMode('gui')">è¡¨å–®ç·¨è¼¯</button><button class="btn btn-sm btn-ghost" onclick="switchPrizeMode('json')">JSON è²¼ä¸Š</button></div>
            </div>
            <div id="prize_gui_mode"><div id="prize_container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div><button class="btn btn-primary btn-sm" style="width:100%; margin-top:10px" onclick="addPrizeRank()">+ æ–°å¢åæ¬¡å€é–“</button></div>
            <div id="prize_json_mode" style="display:none"><textarea id="prize_json_input" style="width:100%; height:200px; font-family:monospace"></textarea><button class="btn btn-success" style="width:100%; margin-top:10px" onclick="smartApplyPrizeJson()">âœ… å¥—ç”¨çå‹µ</button></div>
        </div>
    </div>
    <div class="card"><div class="section-title">å–®ç­† JSON é è¦½</div><div class="json-preview" id="preview"></div></div>
</div>

<datalist id="item_datalist"></datalist>
<div id="import_modal" class="modal"><div class="modal-content"><h3>åŒ¯å…¥æ•´æ‰¹ JSON</h3><textarea id="full_import_input" style="width:100%; height:300px; font-family:monospace"></textarea><div style="margin-top:15px; text-align:right"><button class="btn btn-ghost" onclick="hideImportModal()">å–æ¶ˆ</button><button class="btn btn-success" onclick="processFullImport()">ç¢ºèªåŒ¯å…¥</button></div></div></div>

<script>
    const procedureMap = {
        "Custom_Bison.f_cal_FishTotalWinTimes_FishID": [ {l:"é­šç¨®ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_SlotMaxMultiple_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_FishMaxMultiple_FishID": [ {l:"é­šç¨®ID", t:"string"}, {l:"æŒ‡å®šå»³é¤¨", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"}, {l:"æœ€ä½ä¸Šæ¦œå€æ•¸", t:"number"} ],
        "Custom_Bison.f_cal_CardCollect": [ {l:"å¡å†ŠID", t:"string"}, {l:"æœ€ä½å¡ç‰‡æ•¸", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_CosmicSagaCompleteTimes": [ {l:"é›£åº¦", t:"string"}, {l:"æœ€ä½é—œå¡", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_FishMaxWin_FishID": [ {l:"é­šç¨®ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_SlotMaxWin_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_LiveEventsCompleteTimes": [ {l:"æ´»å‹•åç¨±", t:"string"}, {l:"æœ€ä½é—œå¡", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_SpaceTravelPoints": [ {l:"æœ€ä½é»æ•¸", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_CardNumber": [ {l:"å¡å†ŠID", t:"string"}, {l:"æœ€ä½å¡ç‰‡æ•¸", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ],
        "Custom_Bison.f_cal_SlotMaxWin_MinMult_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"}, {l:"æœ€ä½ä¸Šæ¦œå€æ•¸", t:"number"} ],
        "Custom_Bison.f_cal_SlotMaxMultiple_MinMult_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"}, {l:"æœ€ä½ä¸Šæ¦œå€æ•¸", t:"number"} ]
    };
    const headerObj = { "round_id": "æ’åID", "round_series_id": "ç³»åˆ—ID", "show_winner_announce": "å»£å®£", "previous_round_id": "å‰ä¸€æª”ID", "category": "é¡åˆ¥", "sub_category": "å­é¡åˆ¥", "sub_category_params": "åƒæ•¸", "bq_update_interval": "æ›´æ–°é »ç‡", "bq_procedure_id": "ç¨‹åºID", "bq_extra_params": "æŸ¥è©¢åƒæ•¸", "start_dt": "é–‹å§‹", "end_dt": "çµæŸ", "reward_dt": "ç½®ç", "ranking_size": "äººæ•¸", "priority": "æ¬Šé‡", "score_type": "åˆ†æ•¸é¡å‹", "score_icon": "Icon", "show_score_source": "ç§€æ©Ÿå°", "popup_reward_rank": "å½ˆçª—åæ¬¡", "prizes": "çå‹µ", "template_code": "ç‰ˆå‹", "msg_title": "æ¨™é¡Œ", "msg_desc": "èªªæ˜", "msg_cond": "æ¢ä»¶" };
    let rounds = [], currentIndex = 0, itemLookup = {}, idToName = {};

    function createDefaultRound() { return { round_id: "NEW_ROUND", round_series_id: "", previous_round_id: "", category: "EVENT", sub_category: "", sub_category_params: "", bq_update_interval: 1800, bq_procedure_id: "", bq_extra_params_raw: '"ID", 1', start_dt: 202602250000, end_dt: 202602262359, reward_dt: 202602270600, ranking_size: 100, priority: 60, score_type: "int", score_icon: "", show_score_source: 0, show_winner_announce: 0, popup_reward_rank: 10, template_code: "list", msg_title: "", msg_desc: "", msg_cond: "", prizes: [] }; }

    function handleProcedureChange(v) { const c = document.getElementById('custom_procedure_input'); if(v === 'CUSTOM'){ c.style.display='block'; rounds[currentIndex].bq_procedure_id = c.value; } else { c.style.display='none'; rounds[currentIndex].bq_procedure_id = v; } renderParamsUI(v); updatePreview(); }
    function renderParamsUI(pId) { const c = document.getElementById('params_ui_container'); c.innerHTML = ''; const s = procedureMap[pId]; if(!s){ c.innerHTML = '<div style="grid-column:span 2;color:#94a3b8;font-size:0.8rem">è«‹é¸æ“‡æ¢ä»¶ä»¥è¨­å®šåƒæ•¸</div>'; return; } let vals = []; try { vals = JSON.parse(`[${rounds[currentIndex].bq_extra_params_raw}]`); } catch(e){} s.forEach((f, i) => { const d = document.createElement('div'); d.className = 'form-group'; d.innerHTML = `<label>${f.l} (${f.t})</label><input type="${f.t==='number'?'number':'text'}" value="${vals[i]!==undefined?vals[i]:''}" oninput="updateParamValue(${i}, this.value, '${f.t}')">`; c.appendChild(d); }); }
    function updateParamValue(i, v, t) { let vals = []; try { vals = JSON.parse(`[${rounds[currentIndex].bq_extra_params_raw}]`); } catch(e){} vals[i] = t === 'number' ? Number(v) : v; rounds[currentIndex].bq_extra_params_raw = vals.map(x => typeof x === 'string' ? `"${x}"` : x).join(', '); document.getElementById('bq_extra_params_raw').value = rounds[currentIndex].bq_extra_params_raw; updatePreview(); }
    function handleRawParamsInput(v) { rounds[currentIndex].bq_extra_params_raw = v; renderParamsUI(rounds[currentIndex].bq_procedure_id); updatePreview(); }

    function handleItemFile(e) {
        const f = e.target.files[0]; const reader = new FileReader();
        reader.onload = (evt) => {
            const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
            const sh = wb.Sheets['ItemInfoList'] || wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sh); itemLookup = {}; idToName = {};
            const dl = document.getElementById('item_datalist'); dl.innerHTML = '';
            json.forEach(x => {
                const id = String(x.ITEM_ID||""), nm = String(x.NOEX_é“å…·åç¨±||"");
                if(id&&nm){ itemLookup[nm]=id; idToName[id]=nm; const o=document.createElement('option'); o.value=nm; o.label=id; dl.appendChild(o); }
            });
            document.getElementById('item_status').innerText = `âœ… å·²è¼‰å…¥ ${json.length} ç­†é“å…·`;
            renderPrizes();
        };
        reader.readAsArrayBuffer(f);
    }

    function onItemIdInput(pIdx, rwIdx, el) { 
        let v = el.value; 
        if(itemLookup[v]){ v = itemLookup[v]; el.value = v; } 
        rounds[currentIndex].prizes[pIdx].reward_list[rwIdx].item_id = v; 
        const b = el.parentElement.querySelector('.item-badge'); 
        if(b) b.innerText = idToName[v] || ""; 
        updatePreview(); 
    }

    function renderPrizes() {
        const c = document.getElementById('prize_container'); c.innerHTML = '';
        rounds[currentIndex].prizes.forEach((p, pIdx) => {
            const d = document.createElement('div'); d.className = 'prize-item';
            let h = `<div style="display:flex; justify-content:space-between"><strong>åæ¬¡: <input type="number" style="width:60px" value="${p.rank}" oninput="rounds[currentIndex].prizes[${pIdx}].rank=parseInt(this.value);updatePreview()"></strong><button class="btn btn-danger btn-sm" onclick="rounds[currentIndex].prizes.splice(${pIdx},1);renderPrizes();updatePreview()">x</button></div>`;
            p.reward_list.forEach((rw, rwIdx) => {
                h += `<div class="reward-row">
                    <div>
                        <input type="text" list="item_datalist" placeholder="é¸å–®æœå°‹..." value="${rw.item_id}" oninput="onItemIdInput(${pIdx}, ${rwIdx}, this)">
                        <span class="item-badge">${idToName[rw.item_id]||""}</span>
                    </div>
                    <input type="number" value="${rw.amount}" oninput="rounds[currentIndex].prizes[${pIdx}].reward_list[${rwIdx}].amount=parseInt(this.value);updatePreview()">
                    <button class="btn btn-ghost btn-sm" onclick="rounds[currentIndex].prizes[${pIdx}].reward_list.splice(${rwIdx},1);renderPrizes();updatePreview()">-</button>
                </div>`;
            });
            h += `<button class="btn btn-ghost btn-sm" style="width:100%; margin-top:5px" onclick="rounds[currentIndex].prizes[${pIdx}].reward_list.push({item_id:'',amount:0});renderPrizes()">+ çå‹µ</button>`;
            d.innerHTML = h; c.appendChild(d);
        });
    }

    function switchPrizeMode(m) { if(m==='json') document.getElementById('prize_json_input').value=JSON.stringify(rounds[currentIndex].prizes,null,2); document.getElementById('prize_gui_mode').style.display=m==='gui'?'block':'none'; document.getElementById('prize_json_mode').style.display=m==='json'?'block':'none'; if(m==='gui') renderPrizes(); }
    function smartApplyPrizeJson() { try { rounds[currentIndex].prizes = JSON.parse(document.getElementById('prize_json_input').value.replace(/,\s*([\]}])/g, '$1')); switchPrizeMode('gui'); renderPrizes(); updatePreview(); } catch(e){alert("JSON éŒ¯èª¤");} }
    function addNewRound() { rounds.push(createDefaultRound()); currentIndex = rounds.length - 1; renderRoundList(); loadRound(); }
    function cloneCurrentRound() { const c = JSON.parse(JSON.stringify(rounds[currentIndex])); c.round_id += "_COPY"; rounds.push(c); currentIndex = rounds.length - 1; renderRoundList(); loadRound(); }
    function renderRoundList() { const ui = document.getElementById('round_list_ui'); ui.innerHTML = ''; rounds.forEach((r, i) => { const d = document.createElement('div'); d.className = `round-item ${i === currentIndex ? 'active' : ''}`; d.onclick = () => { currentIndex = i; renderRoundList(); loadRound(); }; d.innerHTML = `<span>${r.round_id}</span><button class="btn btn-danger btn-sm" onclick="event.stopPropagation();rounds.splice(${i},1);currentIndex=0;renderRoundList();loadRound();">x</button>`; ui.appendChild(d); }); }
    function loadRound() {
        const r = rounds[currentIndex]; document.getElementById('editing_title').innerText = `ç·¨è¼¯ï¼š${r.round_id}`;
        Object.keys(r).forEach(k => { const el = document.getElementById(k); if(el && k!=='prizes') el.value = r[k]; });
        document.getElementById('bq_procedure_id').value = procedureMap[r.bq_procedure_id] ? r.bq_procedure_id : (r.bq_procedure_id ? "CUSTOM" : "");
        const toP = (n) => { const s = String(n); return s.length < 12 ? "" : `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T${s.slice(8,10)}:${s.slice(10,12)}`; };
        document.getElementById('start_dt_picker').value = toP(r.start_dt); document.getElementById('end_dt_picker').value = toP(r.end_dt); document.getElementById('reward_dt_picker').value = toP(r.reward_dt);
        renderParamsUI(r.bq_procedure_id); renderPrizes(); updatePreview();
    }
    function handleInput(e, f) { rounds[currentIndex][f] = e.target.value; if(f === 'round_id') renderRoundList(); updatePreview(); }
    function handleNumInput(e, f) { rounds[currentIndex][f] = parseInt(e.target.value) || 0; updatePreview(); }
    function handleDateInput(e, f) { rounds[currentIndex][f] = parseInt(e.target.value.replace(/[-T:]/g, '')) || 0; updatePreview(); }
    function addPrizeRank() { rounds[currentIndex].prizes.push({rank: 1, reward_list: []}); renderPrizes(); }
    function getCleanData(r) { let p = []; const raw = r.bq_extra_params_raw || ""; try { if(raw.trim().startsWith('[')) p = JSON.parse(raw); else p = JSON.parse(`[${raw}]`); } catch(e) { p = raw.split(',').map(s => { s = s.trim(); if(s.startsWith('"')) return s.slice(1,-1); return isNaN(s)||s===""?s:Number(s); }); } const res = {...r}; delete res.bq_extra_params_raw; res.bq_extra_params = p; return res; }
    function updatePreview() { document.getElementById('preview').innerText = JSON.stringify(getCleanData(rounds[currentIndex]), null, 2); }
    function downloadJson() { const g = document.getElementById('group_name').value; const f = {}; f[g] = [headerObj, ...rounds.map(r => getCleanData(r))]; const b = new Blob([JSON.stringify(f, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `${g}.json`; a.click(); }
    function showImportModal() { document.getElementById('import_modal').style.display = 'block'; }
    function hideImportModal() { document.getElementById('import_modal').style.display = 'none'; }
    function processFullImport() { try { let d = JSON.parse(document.getElementById('full_import_input').value); if(!Array.isArray(d)) { const k = Object.keys(d)[0]; document.getElementById('group_name').value = k; d = d[k]; } if(d[0].round_id === "æ’åID") d.shift(); rounds = d.map(x => { const r = {...createDefaultRound(), ...x}; r.bq_extra_params_raw = (x.bq_extra_params || []).map(v => typeof v === 'string' ? `"${v}"` : v).join(', '); return r; }); currentIndex = 0; renderRoundList(); loadRound(); hideImportModal(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } }

    addNewRound();
</script>
</body>
</html>
