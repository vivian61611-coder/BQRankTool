<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’è¡Œæ¦œ JSON ç‡Ÿé‹è¨­å®šå·¥å…· (Excel åŒ¯å…¥ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #2563eb; --secondary-color: #6366f1; --bg-color: #f1f5f9; --card-bg: #ffffff; --border-color: #cbd5e1; --text-color: #0f172a; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 320px; background: #1e293b; color: white; display: flex; flex-direction: column; border-right: 1px solid #0f172a; flex-shrink: 0; }
        .sidebar-header { padding: 20px; background: #0f172a; }
        .round-list { flex: 1; overflow-y: auto; padding: 10px; }
        .round-item { padding: 12px 15px; margin-bottom: 8px; background: #334155; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .round-item:hover { background: #475569; }
        .round-item.active { background: var(--primary-color); box-shadow: 0 0 10px rgba(37,99,235,0.3); }
        
        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 25px 40px; background: var(--bg-color); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        /* Layout Grid System */
        .layout-grid { display: flex; flex-direction: column; gap: 20px; }
        .layout-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .layout-full { width: 100%; }

        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border-color); height: fit-content; }
        .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: var(--primary-color); border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 12px; display: flex; flex-direction: column; gap: 4px; }
        .full-col { grid-column: span 2; }
        
        label { font-weight: 600; font-size: 0.8rem; color: #475569; }
        input, select, textarea { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; width: 100%; box-sizing: border-box; }
        
        /* Search Dropdown */
        .item-search-container { position: relative; width: 100%; }
        .item-dropdown { position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: white; border: 1px solid #cbd5e1; border-radius: 4px; z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; }
        .item-option { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; display: flex; flex-direction: column; }
        .item-option:hover { background: #f1f5f9; }
        .opt-id { font-weight: bold; color: var(--primary-color); }
        .opt-name { font-size: 0.75rem; color: #64748b; }
        .item-badge { background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-top: 4px; display: inline-block; font-weight: bold; }

        .params-container { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--border-color); margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .prize-item { background: #f8fafc; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .reward-row { display: grid; grid-template-columns: 1.5fr 1fr auto; gap: 8px; margin-top: 8px; align-items: start; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-ghost { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .json-preview { background: #0f172a; color: #38bdf8; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; white-space: pre; overflow: auto; max-height: 400px; }
    </style>
</head>
<body onclick="hideAllDropdowns()">

<div class="sidebar">
    <div class="sidebar-header">
        <button class="btn btn-primary" style="width:100%" onclick="addNewRound()">+ æ–°å¢æ´»å‹•è¼ªæ¬¡</button>
        <button class="btn btn-secondary" style="width:100%; margin-top:12px" onclick="document.getElementById('excel_input').click()">ğŸ“¥ åŒ¯å…¥é“å…·è¡¨ (.xlsx)</button>
        <input type="file" id="excel_input" hidden accept=".xlsx" onchange="importItemExcel(event)">
        <div id="item_count_status" style="font-size:0.7rem; margin-top:10px; color:#94a3b8">é“å…·è¡¨ç‹€æ…‹: å°šæœªåŒ¯å…¥</div>
    </div>
    <div class="round-list" id="round_list_ui"></div>
    <div style="padding:20px; border-top: 1px solid #0f172a;">
        <div class="form-group"><label style="color:#94a3b8">åŒ¯å‡ºæª”æ¡ˆåç¨±</label><input type="text" id="group_name" value="round_infos" oninput="updatePreview()"></div>
        <button class="btn btn-success" style="width:100%" onclick="downloadJson()">ğŸ’¾ åŒ¯å‡ºæ­£å¼ JSON é™£åˆ—</button>
    </div>
</div>

<div class="main-content">
    <header><h2 id="editing_title">ç·¨è¼¯æ´»å‹•</h2><button class="btn btn-ghost" onclick="cloneCurrentRound()">ğŸ‘¯ è¤‡è£½ç›®å‰æ´»å‹•</button></header>
    
    <div class="layout-grid">
        <!-- 1. æ’è¡Œæ¦œåˆ¤æ–·é‚è¼¯ -->
        <div class="card layout-full">
            <div class="section-title">1. æ’è¡Œæ¦œåˆ¤æ–·é‚è¼¯ (Procedure & Params)</div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>ç¨‹åºID(bq_procedure_id)</label>
                    <select id="bq_procedure_id" onchange="handleProcedureChange(this.value)">
                        <option value="">-- è«‹é¸æ“‡åˆ¤æ–·æ¢ä»¶ --</option>
                        <option value="Custom_Bison.f_cal_FishTotalWinTimes_FishID">é­šç¨®ç¸½æ“Šæ®ºæ¬¡æ•¸</option>
                        <option value="Custom_Bison.f_cal_SlotMaxMultiple_GameID">è™æ©Ÿæœ€å¤§å€æ•¸</option>
                        <option value="Custom_Bison.f_cal_FishMaxMultiple_FishID">é­šç¨®æœ€å¤§å€æ•¸</option>
                        <option value="Custom_Bison.f_cal_CardCollect">å¡ç‰‡æ”¶é›†é€²åº¦</option>
                        <option value="Custom_Bison.f_cal_CosmicSagaCompleteTimes">å¢æ—ä¹‹ç‹é—œå¡æ•¸</option>
                        <option value="Custom_Bison.f_cal_FishMaxWin_FishID">é­šæ©Ÿæœ€é«˜è´åˆ†</option>
                        <option value="Custom_Bison.f_cal_SlotMaxWin_GameID">è™æ©Ÿæœ€é«˜è´åˆ†</option>
                        <option value="Custom_Bison.f_cal_LiveEventsCompleteTimes">é™æ™‚æ´»å‹•é—œå¡æ•¸</option>
                        <option value="Custom_Bison.f_cal_SpaceTravelPoints">å¤ªç©ºæ—…è¡Œé»æ•¸</option>
                        <option value="Custom_Bison.f_cal_CardNumber">å¡ç‰‡æ”¶é›†å¼µæ•¸</option>
                        <option value="Custom_Bison.f_cal_SlotMaxWin_MinMult_GameID">è™æ©Ÿæœ€é«˜è´åˆ†(æœ‰é™åˆ¶)</option>
                        <option value="Custom_Bison.f_cal_SlotMaxMultiple_MinMult_GameID">è™æ©Ÿæœ€é«˜è´åˆ†å€æ•¸(æœ‰é™åˆ¶)</option>
                        <option value="CUSTOM">-- æ‰‹å‹•è¼¸å…¥ ID --</option>
                    </select>
                    <input type="text" id="custom_procedure_input" style="display:none; margin-top:5px" placeholder="è«‹è¼¸å…¥ ID" oninput="handleInput(event, 'bq_procedure_id')">
                </div>
                <div class="form-group"><label>è¼ªæ¬¡ID(round_id)</label><input type="text" id="round_id" oninput="handleInput(event, 'round_id')"></div>
            </div>
            <div id="params_ui_container" class="params-container"></div>
            <div class="form-group" style="margin-top:10px">
                <label>ç¨‹åºåƒæ•¸é™£åˆ—é è¦½(bq_extra_params)</label>
                <input type="text" id="bq_extra_params_raw" oninput="handleRawParamsInput(this.value)">
            </div>
        </div>

        <!-- Row 1: 2 & 3 -->
        <div class="layout-row">
            <div class="card">
                <div class="section-title">2. åˆ†é¡èˆ‡é—œè¯è¨­å®š</div>
                <div class="form-grid-2">
                    <div class="form-group"><label>ç³»åˆ—ID(round_series_id)</label><input type="text" id="round_series_id" oninput="handleInput(event, 'round_series_id')"></div>
                    <div class="form-group"><label>å‰ä¸€æª”ID(previous_round_id)</label><input type="text" id="previous_round_id" oninput="handleInput(event, 'previous_round_id')"></div>
                    <div class="form-group"><label>é¡åˆ¥(category)</label><select id="category" onchange="handleInput(event, 'category')"><option value="EVENT">EVENT</option><option value="SLOT">SLOT</option><option value="SHOOTING">SHOOTING</option></select></div>
                    <div class="form-group"><label>å­é¡åˆ¥(sub_category)</label><input type="text" id="sub_category" oninput="handleInput(event, 'sub_category')"></div>
                    <div class="form-group full-col"><label>å­é¡åˆ¥åƒæ•¸(sub_category_params)</label><input type="text" id="sub_category_params" oninput="handleInput(event, 'sub_category_params')"></div>
                </div>
            </div>
            <div class="card">
                <div class="section-title">3. æ™‚é–“èˆ‡æ’ç¨‹è¨­å®š</div>
                <div class="form-grid-2">
                    <div class="form-group"><label>é–‹å§‹æ™‚é–“(start_dt)</label><input type="datetime-local" id="start_dt_picker" step="60" onchange="handleDateInput(event, 'start_dt')"></div>
                    <div class="form-group"><label>çµæŸæ™‚é–“(end_dt)</label><input type="datetime-local" id="end_dt_picker" step="60" onchange="handleDateInput(event, 'end_dt')"></div>
                    <div class="form-group"><label>ç½®çæ™‚é–“(reward_dt)</label><input type="datetime-local" id="reward_dt_picker" step="60" onchange="handleDateInput(event, 'reward_dt')"></div>
                    <div class="form-group"><label>æ›´æ–°é »ç‡(bq_update_interval)</label><input type="number" id="bq_update_interval" oninput="handleNumInput(event, 'bq_update_interval')"></div>
                </div>
            </div>
        </div>

        <!-- Row 2: 4 & 5 -->
        <div class="layout-row">
            <div class="card">
                <div class="section-title">4. é¡¯ç¤ºæ§åˆ¶èˆ‡æ•¸å€¼æ ¼å¼</div>
                <div class="form-grid-2">
                    <div class="form-group"><label>é¡¯ç¤ºå»£å®£(show_winner_announce)</label><select id="show_winner_announce" onchange="handleBoolNumInput(event, 'show_winner_announce')"><option value="0">0 (å¦)</option><option value="1">1 (æ˜¯)</option></select></div>
                    <div class="form-group"><label>æ¦œå–®äººæ•¸(ranking_size)</label><input type="number" id="ranking_size" oninput="handleNumInput(event, 'ranking_size')"></div>
                    <div class="form-group"><label>å„ªå…ˆåº(priority)</label><input type="number" id="priority" oninput="handleNumInput(event, 'priority')"></div>
                    <div class="form-group"><label>åˆ†æ•¸é¡å‹(score_type)</label><select id="score_type" onchange="handleInput(event, 'score_type')"><option value="int">int</option><option value="multiplier">multiplier</option><option value="coin">coin</option></select></div>
                    <div class="form-group"><label>åˆ†æ•¸åœ–ç¤º(score_icon)</label><input type="text" id="score_icon" oninput="handleInput(event, 'score_icon')"></div>
                    <div class="form-group"><label>ç§€æ©Ÿå°(show_score_source)</label><select id="show_score_source" onchange="handleBoolNumInput(event, 'show_score_source')"><option value="0">0 (å¦)</option><option value="1">1 (æ˜¯)</option></select></div>
                    <div class="form-group"><label>å½ˆçª—ç½®çåæ¬¡(popup_reward_rank)</label><input type="number" id="popup_reward_rank" oninput="handleNumInput(event, 'popup_reward_rank')"></div>
                    <div class="form-group"><label>ç‰ˆå‹(template_code)</label><input type="text" id="template_code" oninput="handleInput(event, 'template_code')"></div>
                </div>
            </div>
            <div class="card">
                <div class="section-title">5. è¨Šæ¯è¨­å®š</div>
                <div class="form-group"><label>æ¨™é¡Œ(msg_title)</label><input type="text" id="msg_title" oninput="handleInput(event, 'msg_title')"></div>
                <div class="form-group"><label>èªªæ˜(msg_desc)</label><textarea id="msg_desc" style="height:65px" oninput="handleInput(event, 'msg_desc')"></textarea></div>
                <div class="form-group"><label>æ¢ä»¶(msg_cond)</label><textarea id="msg_cond" style="height:65px" oninput="handleInput(event, 'msg_cond')"></textarea></div>
            </div>
        </div>

        <!-- 6. çå‹µè¨­å®š -->
        <div class="card layout-full">
            <div class="section-title"><span>6. çå‹µè¨­å®š (Prizes)</span><div><button class="btn btn-sm btn-primary" onclick="switchPrizeMode('gui')">è¡¨å–®ç·¨è¼¯</button><button class="btn btn-sm btn-ghost" onclick="switchPrizeMode('json')">JSON è²¼ä¸Š</button></div></div>
            <div id="prize_gui_mode">
                <div id="prize_container" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;"></div>
                <button class="btn btn-primary btn-sm" style="width:100%; margin-top:10px" onclick="addPrizeRank()">+ æ–°å¢åæ¬¡å€é–“</button>
            </div>
            <div id="prize_json_mode" style="display:none"><textarea id="prize_json_input" style="width:100%; height:200px; font-family:monospace"></textarea><button class="btn btn-success" style="width:100%; margin-top:10px" onclick="smartApplyPrizeJson()">âœ… å¥—ç”¨çå‹µ</button></div>
        </div>
    </div>
    <div class="card layout-full"><div class="section-title">æœ€çµ‚è¼¸å‡ºé è¦½</div><div class="json-preview" id="preview"></div></div>
</div>

<script>
    let itemData = []; // ç”± Excel åŒ¯å…¥å¡«å……

    const procedureMap = { "Custom_Bison.f_cal_FishTotalWinTimes_FishID": [ {l:"é­šç¨®ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_SlotMaxMultiple_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_FishMaxMultiple_FishID": [ {l:"é­šç¨®ID", t:"string"}, {l:"æŒ‡å®šå»³é¤¨", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"}, {l:"æœ€ä½ä¸Šæ¦œå€æ•¸", t:"number"} ], "Custom_Bison.f_cal_CardCollect": [ {l:"å¡å†ŠID", t:"string"}, {l:"æœ€ä½å¡ç‰‡æ•¸", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_CosmicSagaCompleteTimes": [ {l:"é›£åº¦", t:"string"}, {l:"æœ€ä½é—œå¡", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_FishMaxWin_FishID": [ {l:"é­šç¨®ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_SlotMaxWin_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_LiveEventsCompleteTimes": [ {l:"æ´»å‹•åç¨±", t:"string"}, {l:"æœ€ä½é—œå¡", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_SpaceTravelPoints": [ {l:"æœ€ä½é»æ•¸", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_CardNumber": [ {l:"å¡å†ŠID", t:"string"}, {l:"æœ€ä½å¡ç‰‡æ•¸", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"} ], "Custom_Bison.f_cal_SlotMaxWin_MinMult_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"}, {l:"æœ€ä½ä¸Šæ¦œå€æ•¸", t:"number"} ], "Custom_Bison.f_cal_SlotMaxMultiple_MinMult_GameID": [ {l:"éŠæˆ²ID", t:"string"}, {l:"æœ€ä½æŠ¼æ³¨æ®µ", t:"number"}, {l:"æœ€ä½ç­‰ç´š", t:"number"}, {l:"æœ€ä½ä¸Šæ¦œå€æ•¸", t:"number"} ] };
    let rounds = [], currentIndex = 0;
    function createDefaultRound() { return { round_id: "NEW_ROUND", round_series_id: "", show_winner_announce: 0, previous_round_id: "", category: "SLOT", sub_category: "", sub_category_params: "", bq_update_interval: 1800, bq_procedure_id: "", bq_extra_params_raw: '', start_dt: 202602250000, end_dt: 202602262359, reward_dt: 202602270600, ranking_size: 100, priority: 60, score_type: "int", score_icon: "", show_score_source: 0, popup_reward_rank: 10, template_code: "list", msg_title: "", msg_desc: "", msg_cond: "", prizes: [] }; }

    // --- Excel Import Logic ---
    function importItemExcel(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            const sheet = wb.Sheets["ItemInfoList"];
            if(!sheet) { alert("æ‰¾ä¸åˆ° 'ItemInfoList' å·¥ä½œè¡¨ï¼"); return; }
            const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
            itemData = rows.slice(1).map(r => ({ name: r[2], id: r[4] })).filter(x => x.id);
            document.getElementById('item_count_status').innerText = `é“å…·è¡¨ç‹€æ…‹: å·²è®€å– ${itemData.length} ç­†è³‡æ–™`;
            alert("é“å…·è¡¨åŒ¯å…¥æˆåŠŸï¼ç¾åœ¨å¯ä»¥åœ¨çå‹µè¨­å®šé€²è¡Œæœå°‹ã€‚");
            renderPrizes();
        };
        reader.readAsBinaryString(file);
    }

    // --- Search Dropdown Logic ---
    function filterItems(el, pIdx, rwIdx) {
        const d = el.nextElementSibling;
        const kw = el.value.trim().toLowerCase();
        const m = (kw === "") ? itemData.slice(0, 100) : itemData.filter(x => String(x.id).toLowerCase().includes(kw) || String(x.name).toLowerCase().includes(kw)).slice(0, 100);
        d.style.display = 'block';
        d.innerHTML = m.map(x => `<div class="item-option" onmousedown="selectItem('${x.id}', ${pIdx}, ${rwIdx})"><span class="opt-id">${x.id}</span><span class="opt-name">${x.name}</span></div>`).join('') || '<div style="padding:10px; color:#94a3b8">ç„¡åŒ¹é…é …ç›®</div>';
    }
    function selectItem(id, pIdx, rwIdx) { if(rounds[currentIndex].prizes[pIdx]) rounds[currentIndex].prizes[pIdx].reward_list[rwIdx].item_id = id; hideAllDropdowns(); renderPrizes(); updatePreview(); }
    function hideAllDropdowns() { document.querySelectorAll('.item-dropdown').forEach(d => d.style.display = 'none'); }

    function renderPrizes() {
        const c = document.getElementById('prize_container'); c.innerHTML = '';
        if(!rounds[currentIndex]) return;
        (rounds[currentIndex].prizes || []).forEach((p, pIdx) => {
            const d = document.createElement('div'); d.className = 'prize-item';
            let html = `<div style="display:flex; justify-content:space-between"><strong>åæ¬¡: <input type="number" style="width:60px" value="${p.rank}" oninput="rounds[currentIndex].prizes[${pIdx}].rank=parseInt(this.value);updatePreview()"></strong><button class="btn btn-danger btn-sm" onclick="rounds[currentIndex].prizes.splice(${pIdx},1);renderPrizes();updatePreview()">x</button></div>`;
            (p.reward_list || []).forEach((rw, rwIdx) => {
                const item = itemData.find(x => x.id === rw.item_id);
                html += `<div class="reward-row"><div class="item-search-container"><input type="text" placeholder="æœå°‹..." value="${rw.item_id}" onfocus="filterItems(this, ${pIdx}, ${rwIdx})" oninput="filterItems(this, ${pIdx}, ${rwIdx})"><div class="item-dropdown"></div><span class="item-badge">${item ? item.name : ""}</span></div><input type="number" value="${rw.amount}" oninput="rounds[currentIndex].prizes[${pIdx}].reward_list[${rwIdx}].amount=parseInt(this.value);updatePreview()"><button class="btn btn-ghost btn-sm" onclick="rounds[currentIndex].prizes[${pIdx}].reward_list.splice(${rwIdx},1);renderPrizes();updatePreview()">-</button></div>`;
            });
            html += `<button class="btn btn-ghost btn-sm" style="width:100%; margin-top:10px" onclick="addRewardItem(${pIdx})">+ é“å…·çå‹µ</button>`;
            d.innerHTML = html; c.appendChild(d);
        });
    }

    // --- Core Logic (Unchanged) ---
    function handleProcedureChange(v) { const c = document.getElementById('custom_procedure_input'); if(v==='CUSTOM'){ c.style.display='block'; rounds[currentIndex].bq_procedure_id=c.value; } else { c.style.display='none'; rounds[currentIndex].bq_procedure_id=v; } renderParamsUI(v); updatePreview(); }
    function renderParamsUI(pId) { const c = document.getElementById('params_ui_container'); c.innerHTML = ''; const s = procedureMap[pId]; if(!s) return; let vls = []; try { vls = JSON.parse(`[${rounds[currentIndex].bq_extra_params_raw}]`); } catch(e){} s.forEach((f, i) => { const d = document.createElement('div'); d.className = 'form-group'; d.innerHTML = `<label>${f.l}</label><input type="${f.t==='number'?'number':'text'}" value="${vls[i]!==undefined?vls[i]:''}" oninput="updateParamValue(${i}, this.value, '${f.t}')">`; c.appendChild(d); }); }
    function updateParamValue(i, v, t) { let vls = []; try { vls = JSON.parse(`[${rounds[currentIndex].bq_extra_params_raw}]`); } catch(e){} vls[i] = t==='number'?Number(v):v; rounds[currentIndex].bq_extra_params_raw = vls.map(x=>typeof x==='string'?`"${x}"`:x).join(', '); document.getElementById('bq_extra_params_raw').value = rounds[currentIndex].bq_extra_params_raw; updatePreview(); }
    function handleRawParamsInput(v) { rounds[currentIndex].bq_extra_params_raw=v; renderParamsUI(rounds[currentIndex].bq_procedure_id); updatePreview(); }
    function loadRound() { const r=rounds[currentIndex]; document.getElementById('editing_title').innerText=`ç·¨è¼¯ï¼š${r.round_id}`; const flds=['round_id','round_series_id','show_winner_announce','previous_round_id','category','sub_category','sub_category_params','bq_update_interval','priority','ranking_size','score_type','score_icon','show_score_source','popup_reward_rank','template_code','msg_title','msg_desc','msg_cond','bq_extra_params_raw']; flds.forEach(f => { const el=document.getElementById(f); if(el) el.value=r[f]!==undefined?String(r[f]):''; }); document.getElementById('bq_procedure_id').value = procedureMap[r.bq_procedure_id]?r.bq_procedure_id:(r.bq_procedure_id?"CUSTOM":""); const toP=(n)=>{ const s=String(n); return s.length<12?"":`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}T${s.slice(8,10)}:${s.slice(10,12)}`; }; document.getElementById('start_dt_picker').value=toP(r.start_dt); document.getElementById('end_dt_picker').value=toP(r.end_dt); document.getElementById('reward_dt_picker').value=toP(r.reward_dt); renderParamsUI(r.bq_procedure_id); renderPrizes(); updatePreview(); }
    function handleInput(e, f) { rounds[currentIndex][f]=e.target.value; if(f==='round_id') renderRoundList(); updatePreview(); }
    function handleNumInput(e, f) { rounds[currentIndex][f]=parseInt(e.target.value)||0; updatePreview(); }
    function handleBoolNumInput(e, f) { rounds[currentIndex][f]=parseInt(e.target.value); updatePreview(); }
    function handleDateInput(e, f) { rounds[currentIndex][f]=parseInt(e.target.value.replace(/[-T:]/g,''))||0; updatePreview(); }
    function addNewRound() { rounds.push(createDefaultRound()); currentIndex=rounds.length-1; renderRoundList(); loadRound(); }
    function cloneCurrentRound() { const c=JSON.parse(JSON.stringify(rounds[currentIndex])); c.round_id+="_COPY"; rounds.push(c); currentIndex=rounds.length-1; renderRoundList(); loadRound(); }
    function renderRoundList() { const ui=document.getElementById('round_list_ui'); ui.innerHTML=''; rounds.forEach((r,i)=>{ const d=document.createElement('div'); d.className=`round-item ${i===currentIndex?'active':''}`; d.onclick=()=>{currentIndex=i; renderRoundList(); loadRound();}; d.innerHTML=`<span>${r.round_id}</span><button class="btn btn-danger btn-sm" onclick="event.stopPropagation();rounds.splice(${i},1);currentIndex=0;renderRoundList();loadRound();">x</button>`; ui.appendChild(d); }); }
    function getCleanData(r) { let p=[]; try { p=JSON.parse(`[${r.bq_extra_params_raw}]`); } catch(e){ p=r.bq_extra_params_raw.split(',').map(s=>{ s=s.trim(); if(s.startsWith('"')) return s.slice(1,-1); return isNaN(s)||s===""?s:Number(s); }); } return { round_id: r.round_id||"", round_series_id: r.round_series_id||"", show_winner_announce: parseInt(r.show_winner_announce)||0, previous_round_id: r.previous_round_id||"", category: r.category||"", sub_category: r.sub_category||"", sub_category_params: r.sub_category_params||"", bq_update_interval: parseInt(r.bq_update_interval)||0, bq_procedure_id: r.bq_procedure_id||"", bq_extra_params: p, start_dt: parseInt(r.start_dt)||0, end_dt: parseInt(r.end_dt)||0, reward_dt: parseInt(r.reward_dt)||0, ranking_size: parseInt(r.ranking_size)||0, priority: parseInt(r.priority)||0, score_type: r.score_type||"", score_icon: r.score_icon||"", show_score_source: parseInt(r.show_score_source)||0, popup_reward_rank: parseInt(r.popup_reward_rank)||0, prizes: r.prizes||[], template_code: r.template_code||"", msg_title: r.msg_title||"", msg_desc: r.msg_desc||"", msg_cond: r.msg_cond||"" }; }
    function updatePreview() { document.getElementById('preview').innerText = JSON.stringify(rounds.map(r => getCleanData(r)), null, 2); }
    function downloadJson() { const name=document.getElementById('group_name').value||'round_infos'; const blob=new Blob([JSON.stringify(rounds.map(r=>getCleanData(r)),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${name}.json`; a.click(); }
    function switchPrizeMode(m) { if(m==='json') document.getElementById('prize_json_input').value=JSON.stringify(rounds[currentIndex].prizes,null,2); document.getElementById('prize_gui_mode').style.display=m==='gui'?'block':'none'; document.getElementById('prize_json_mode').style.display=m==='json'?'block':'none'; if(m==='gui') renderPrizes(); }
    function smartApplyPrizeJson() { try { rounds[currentIndex].prizes=JSON.parse(document.getElementById('prize_json_input').value.replace(/,\s*([\]}])/g,'$1')); switchPrizeMode('gui'); renderPrizes(); updatePreview(); } catch(e){alert("JSON éŒ¯èª¤");} }
    function addPrizeRank() { if(!rounds[currentIndex].prizes) rounds[currentIndex].prizes = []; rounds[currentIndex].prizes.push({rank: 1, reward_list: []}); renderPrizes(); updatePreview(); }
    function addRewardItem(pIdx) { rounds[currentIndex].prizes[pIdx].reward_list.push({item_id:'', amount:0}); renderPrizes(); updatePreview(); }
    addNewRound();
</script>
</body>
</html>
